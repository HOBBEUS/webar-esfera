<!DOCTYPE html>
<html>
  <head>
    <title>Juego de descubrir imagen en AR</title>
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://cdn.rawgit.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <style> body { margin: 0; overflow: hidden; } </style>
  </head>
  <body>
    <a-scene embedded arjs>
      <!-- Marcador personalizado -->
      <a-marker id="mi-marcador" type="pattern" url="mipattern.patt">
        
        <!-- Plano base con imagen original -->
        <a-plane position="0 0 0" rotation="-90 0 0" width="1" height="1" src="#imagenBase"></a-plane>

        <!-- Plano con textura dinámica para revelar imagen descubierta -->
        <a-plane 
          id="plano-revelador" 
          position="0 0.01 0" 
          rotation="-90 0 0" 
          width="1" 
          height="1" 
          material="shader: flat; src: #texturaCanvas; transparent: true;">
        </a-plane>

        <!-- Esfera que se mueve -->
        <a-sphere id="esfera" position="0 0.1 0" radius="0.15" color="red"></a-sphere>
      </a-marker>

      <a-assets>
        <img id="imagenBase" src="base.jpg">
        <img id="imagenDescubierta" src="descubierta.png">
        <canvas id="canvasReveal" width="1024" height="1024"></canvas>
      </a-assets>

      <a-entity camera></a-entity>
    </a-scene>

    <script>
      AFRAME.registerComponent('descubrir-imagen', {
        init: function () {
          // Elementos 3D
          this.marker = document.querySelector('#mi-marcador').object3D;
          this.sphere = document.querySelector('#esfera').object3D;

          // Canvas y contexto
          const canvas = document.getElementById('canvasReveal');
          this.ctx = canvas.getContext('2d');

          // Imagen descubierta
          const img = document.getElementById('imagenDescubierta');
          img.onload = () => {
            this.ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            this.ctx.globalCompositeOperation = 'destination-in';
          };

          this.canvas = canvas;
          this.texture = new THREE.CanvasTexture(canvas);
          document.querySelector('#plano-revelador').getObject3D('mesh').material.map = this.texture;

          // Movimiento de física
          this.velocity = new THREE.Vector3();
          this.lastMarkerPosition = new THREE.Vector3();
          this.tempPosition = new THREE.Vector3();
        },
        tick: function () {
          if (!this.marker.visible) return;

          this.marker.getWorldPosition(this.tempPosition);
          const delta = this.tempPosition.clone().sub(this.lastMarkerPosition);

          // Simular peso
          const force = delta.clone().multiplyScalar(10);
          this.velocity.add(force);
          this.velocity.multiplyScalar(0.85);

          const pos = this.sphere.position.clone().add(this.velocity.clone().multiplyScalar(0.012));
          const maxDist = 0.4;
          if (pos.length() > maxDist) {
            pos.normalize().multiplyScalar(maxDist);
            this.velocity.multiplyScalar(-0.3);
          }

          this.sphere.position.copy(pos);
          this.lastMarkerPosition.copy(this.tempPosition);

          // Convertir posición de esfera a coordenadas de canvas (UV)
          const uvx = (pos.x + 0.5) * 1024;
          const uvy = (0.5 - pos.z) * 1024;

          // Dibujar “máscara” circular transparente
          this.ctx.beginPath();
          this.ctx.arc(uvx, uvy, 40, 0, Math.PI * 2); // radio del pincel
          this.ctx.fillStyle = 'black';
          this.ctx.fill();

          // Marcar canvas como actualizado
          this.texture.needsUpdate = true;
        }
      });

      document.querySelector('a-scene').setAttribute('descubrir-imagen', '');
    </script>
  </body>
</html>




